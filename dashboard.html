<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepmakerV5.5 Dashboard</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(145deg, #f6f9fc 0%, #edf2f7 100%);
            color: #1e293b;
            line-height: 1.5;
            min-height: 100vh;
            padding: 24px;
        }
        .dashboard { max-width: 1280px; margin: 0 auto; }
        .header-card {
            background: white; border-radius: 24px; padding: 32px; margin-bottom: 32px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05), 0 8px 10px -6px rgba(0,0,0,0.02);
            border: 1px solid rgba(0,0,0,0.03);
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
        }
        .logo-area { display: flex; align-items: center; gap: 16px; }
        .logo-icon {
            width: 56px; height: 56px;
            background: linear-gradient(135deg, #2563eb, #1e40af);
            border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 28px;
            box-shadow: 0 10px 15px -3px rgba(37,99,235,0.2);
        }
        .logo-text h1 {
            font-size: 1.8rem; font-weight: 700;
            background: linear-gradient(135deg, #1e293b, #2563eb);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .logo-text .badge {
            background: #e2e8f0; color: #475569; padding: 4px 12px; border-radius: 40px;
            font-size: 0.7rem; font-weight: 600; letter-spacing: 0.3px;
        }
        .header-actions {
            display: flex; align-items: center; gap: 16px;
        }
        .license-badge {
            background: #0f172a; color: white; padding: 12px 24px; border-radius: 60px;
            display: flex; align-items: center; gap: 12px; font-size: 0.9rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .license-badge i { color: #fbbf24; }
        .license-code {
            font-family: 'SF Mono', 'Fira Code', monospace; letter-spacing: 1px;
            background: rgba(255,255,255,0.1); padding: 4px 12px; border-radius: 40px;
        }
        .logout-btn {
            background: #ef4444; color: white; border: none; border-radius: 40px;
            padding: 12px 24px; font-size: 0.9rem; font-weight: 600;
            display: flex; align-items: center; gap: 8px; cursor: pointer;
            transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(239,68,68,0.2);
        }
        .logout-btn:hover {
            background: #dc2626; transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(239,68,68,0.3);
        }
        .logout-btn i { font-size: 1rem; }
        .logout-btn.loading {
            pointer-events: none; opacity: 0.7;
        }
        .logout-btn .spinner {
            display: none; width: 18px; height: 18px;
            border: 2px solid white; border-top-color: transparent;
            border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        .logout-btn.loading .spinner {
            display: inline-block;
        }
        .logout-btn.loading .btn-text {
            display: none;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px;
            margin-bottom: 32px;
        }
        .stat-card {
            background: white; border-radius: 20px; padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); }
        .stat-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;
        }
        .stat-title {
            color: #64748b; font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .stat-icon {
            width: 42px; height: 42px; background: #eef2ff; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; color: #2563eb; font-size: 1.2rem;
        }
        .stat-value { font-size: 2rem; font-weight: 700; color: #0f172a; margin-bottom: 4px; }
        .stat-change {
            font-size: 0.85rem; color: #64748b; display: flex; align-items: center; gap: 6px;
        }
        .success { color: #10b981; } .danger { color: #ef4444; } .warning { color: #f59e0b; }
        .account-card {
            background: white; border-radius: 20px; padding: 24px; margin-bottom: 20px;
            border: 1px solid #e2e8f0; transition: box-shadow 0.2s;
        }
        .account-card:hover { box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); }
        .account-header {
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        .account-title { display: flex; align-items: center; gap: 12px; }
        .account-title i { font-size: 1.5rem; color: #2563eb; }
        .account-title h3 { font-size: 1.2rem; font-weight: 600; margin-bottom: 2px; }
        .server { font-size: 0.8rem; color: #64748b; }
        .toggle-container {
            display: flex; align-items: center; gap: 12px; background: #f8fafc; padding: 8px 16px; border-radius: 40px;
        }
        .power-label { font-size: 0.9rem; color: #475569; }
        .switch { position: relative; display: inline-block; width: 52px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #cbd5e1; transition: 0.3s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px;
            background-color: white; transition: 0.3s; border-radius: 50%;
        }
        input:checked + .slider { background-color: #2563eb; }
        input:checked + .slider:before { transform: translateX(24px); }
        .power-status { font-weight: 600; font-size: 0.9rem; }
        .power-status.on { color: #2563eb; } .power-status.off { color: #64748b; }
        .account-details {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px;
            background: #f8fafc; padding: 20px; border-radius: 16px;
        }
        .detail-item { display: flex; flex-direction: column; }
        .detail-label {
            font-size: 0.7rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;
        }
        .detail-value { font-size: 1.2rem; font-weight: 600; color: #0f172a; }
        .detail-currency { font-size: 0.7rem; color: #64748b; margin-left: 4px; }
        .detail-change { font-size: 0.8rem; font-weight: 500; }
        .profit { color: #10b981; } .loss { color: #ef4444; }
        .empty-state {
            background: white; border-radius: 20px; padding: 48px; text-align: center; color: #64748b;
            border: 1px dashed #cbd5e1;
        }
        .empty-state i { font-size: 3rem; color: #cbd5e1; margin-bottom: 16px; }
        .empty-state h3 { font-weight: 600; margin-bottom: 8px; color: #334155; }
        .footer {
            margin-top: 40px; text-align: center; color: #94a3b8; font-size: 0.8rem;
            padding: 24px; border-top: 1px solid #e2e8f0;
        }
        @media (max-width: 768px) {
            .header-card { flex-direction: column; align-items: flex-start; gap: 16px; }
            .header-actions { width: 100%; justify-content: space-between; }
            .stats-grid { grid-template-columns: 1fr; }
            .account-header { flex-direction: column; align-items: flex-start; gap: 12px; }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading" style="text-align: center; padding: 50px;">
            <i class="fas fa-spinner fa-spin"></i> Memuat data dashboard...
        </div>
    </div>

    <!-- Live Chat Tawk.to -->
    <script type="text/javascript">
        var Tawk_API = Tawk_API || {}, Tawk_LoadStart = new Date();
        (function() {
            var s1 = document.createElement("script"), s0 = document.getElementsByTagName("script")[0];
            s1.async = true;
            s1.src = 'https://embed.tawk.to/6986e98076ad761c40db5824/1jgrg082c';
            s1.charset = 'UTF-8';
            s1.setAttribute('crossorigin', '*');
            s0.parentNode.insertBefore(s1, s0);
        })();
    </script>

    <script>
        // ========== KONFIGURASI ==========
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyyQydwpANGn6mCTlb7y6N0hDiJG16TezMMcjfLaAkvGPIGhMyzDsgY5l3C3_5F6HZByw/exec'; // GANTI DENGAN URL WEB APP ANDA

        // Ambil parameter license dari URL
        const urlParams = new URLSearchParams(window.location.search);
        const licenseCode = urlParams.get('license') || (window.location.pathname.startsWith('/dash/') ? window.location.pathname.replace('/dash/', '') : null);

        if (!licenseCode) {
            document.getElementById('app').innerHTML = '<div class="error" style="color:red; text-align:center;">Kode lisensi tidak ditemukan</div>';
          }else {
            // Panggil API untuk mendapatkan data portfolio
            fetch(`${GAS_API_URL}?action=getPortfolio&license=${encodeURIComponent(licenseCode)}`, {
                method: 'GET',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' } // Hindari preflight request
            })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                console.log('✅ Data dari API:', data);
                if (data && data.success) {
                    renderDashboard(data);
                } else {
                    throw new Error(data?.error || 'Data tidak valid dari server');
                }
            })
            .catch(error => {
                console.error('❌ Fetch error:', error);
                document.getElementById('app').innerHTML = `<div class="error" style="color:red; text-align:center;">Gagal memuat data: ${error.message}</div>`;
            });
        }

        // ========== FUNGSI RENDER DASHBOARD ==========
        function renderDashboard(portfolio) {
            const user = portfolio.user;
            const accounts = portfolio.accounts;
            const summary = portfolio.summary;

            // Bangun HTML untuk setiap akun
            let accountsHtml = '';
            accounts.forEach(acc => {
                const pnl = (acc.equity - acc.balance).toFixed(2);
                const pnlClass = pnl >= 0 ? 'profit' : 'loss';
                accountsHtml += `
                    <div class="account-card">
                        <div class="account-header">
                            <div class="account-title">
                                <i class="fas fa-chart-line"></i>
                                <div>
                                    <h3>${acc.broker} · ${acc.account_name}</h3>
                                    <span class="server">Device: ${acc.device_id}</span>
                                </div>
                            </div>
                            <div class="toggle-container">
                                <span class="power-label">EA Power</span>
                                <label class="switch">
                                    <input type="checkbox" ${acc.ea_power === 'ON' ? 'checked' : ''} onchange="toggleEA('${acc.device_id.trim()}', this.checked, event)">
                                    <span class="slider round"></span>
                                </label>
                                <span class="power-status ${acc.ea_power === 'ON' ? 'on' : 'off'}">${acc.ea_power}</span>
                            </div>
                        </div>
                        <div class="account-details">
                            <div class="detail-item">
                                <span class="detail-label">Balance</span>
                                <span class="detail-value">$${(acc.balance || 0).toFixed(2)}</span>
                                <span class="detail-currency">${acc.currency}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Equity</span>
                                <span class="detail-value">$${(acc.equity || 0).toFixed(2)}</span>
                                <span class="detail-change ${pnlClass}">${pnl >= 0 ? '+' : ''}$${Math.abs(pnl)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Floating P&L</span>
                                <span class="detail-value ${pnlClass}">${pnl >= 0 ? '+' : ''}$${Math.abs(pnl)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Leverage</span>
                                <span class="detail-value">${acc.leverage || '-'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Last Update</span>
                                <span class="detail-value">${acc.last_update ? new Date(acc.last_update).toLocaleString('id-ID') : '-'}</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            const statusClass = user.valid ? 'success' : 'danger';
            const statusText = user.valid ? 'Aktif' : 'Tidak Aktif';

            const html = `
                <div class="dashboard">
                    <!-- Header -->
                    <div class="header-card">
                        <div class="logo-area">
                            <div class="logo-icon"><i class="fas fa-robot"></i></div>
                            <div class="logo-text">
                                <h1>Deepmaker <span class="badge">V5.5</span></h1>
                                <p style="color: #64748b; margin-top: 4px;"><i class="fas fa-shield-alt" style="color: #2563eb;"></i> Enterprise License Management</p>
                            </div>
                        </div>
                        <div class="header-actions">
                            <div class="license-badge"><i class="fas fa-key"></i><span class="license-code">${licenseCode}</span></div>
                            <button class="logout-btn" onclick="logout()">
                                <i class="fas fa-sign-out-alt"></i>
                                <span class="btn-text">Logout</span>
                                <span class="spinner"></span>
                            </button>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header"><span class="stat-title">Account Status</span><span class="stat-icon"><i class="fas fa-check-circle"></i></span></div>
                            <div class="stat-value ${statusClass}">${statusText}</div>
                            <div class="stat-change"><i class="fas fa-circle" style="font-size: 0.5rem; color: #10b981;"></i> Licensed until ${user.expire}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header"><span class="stat-title">License Package</span><span class="stat-icon"><i class="fas fa-crown"></i></span></div>
                            <div class="stat-value">${user.paket}</div>
                            <div class="stat-change"><i class="fas fa-hourglass-half"></i> ${user.days_left} days left</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header"><span class="stat-title">Total Balance</span><span class="stat-icon"><i class="fas fa-wallet"></i></span></div>
                            <div class="stat-value">$${summary.total_balance.toFixed(2)}</div>
                            <div class="stat-change"><i class="fas fa-chart-line"></i> Across ${summary.total_accounts} accounts</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header"><span class="stat-title">Total Equity</span><span class="stat-icon"><i class="fas fa-coins"></i></span></div>
                            <div class="stat-value">$${summary.total_equity.toFixed(2)}</div>
                            <div class="stat-change"><i class="fas fa-percent"></i> ${(summary.total_equity / summary.total_balance * 100 || 0).toFixed(2)}%</div>
                        </div>
                    </div>

                    <!-- User Info Card -->
                    <div class="account-card" style="padding: 24px;">
                        <div style="display: flex; gap: 32px; flex-wrap: wrap;">
                            <div><span class="detail-label">Nama Lengkap</span><div style="font-weight:600;">${user.nama}</div></div>
                            <div><span class="detail-label">Email</span><div>${user.email}</div></div>
                            <div><span class="detail-label">Masa Aktif</span><div>${user.expire} (${user.days_left} hari)</div></div>
                        </div>
                    </div>

                    <!-- Accounts Section -->
                    <h2 style="margin: 32px 0 16px; font-weight:600; display:flex; align-items:center; gap:8px;">
                        <i class="fas fa-exchange-alt" style="color:#2563eb;"></i> Connected MT5 Accounts
                    </h2>
                    ${accountsHtml || '<div class="empty-state"><i class="fas fa-plug"></i><h3>No MT5 Account Connected</h3><p>Attach EA to your MT5 chart to see account details.</p></div>'}

                    <div class="footer">
                        <i class="fas fa-robot"></i> DeepmakerV5.5 · Enterprise License System · © 2026
                    </div>
                </div>
            `;

            document.getElementById('app').innerHTML = html;
        }

        // ========== FUNGSI TOGGLE EA POWER ==========
        window.toggleEA = function(deviceId, isOn, event) {
            const status = isOn ? 'ON' : 'OFF';
            fetch(`${GAS_API_URL}?action=toggle&license=${licenseCode}&device_id=${encodeURIComponent(deviceId)}&status=${status}`, {
                method: 'GET',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(result => {
                console.log('✅ Toggle result:', result);
                if (result.success) {
                    // Update tampilan
                    const cb = event.target;
                    cb.checked = isOn;
                    const statusSpan = cb.closest('.toggle-container').querySelector('.power-status');
                    if (statusSpan) {
                        statusSpan.innerText = status;
                        statusSpan.className = 'power-status ' + (status === 'ON' ? 'on' : 'off');
                    }
                } else {
                    alert('Gagal: ' + (result.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('❌ Toggle error:', error);
                alert('Error: ' + error.message);
            });
        };

        // ========== FUNGSI LOGOUT ==========
        window.logout = function() {
            const logoutBtn = document.querySelector('.logout-btn');
            if (logoutBtn) {
                logoutBtn.classList.add('loading');
            }
            // Simulasi loading 1 detik lalu redirect ke home (index.html)
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
        };
    </script>
</body>
</html>
